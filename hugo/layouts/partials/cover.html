{{- with .cxt}} {{/* Apply proper context from dict */}}
{{- if (and .Params.cover.image (not $.isHidden)) }}
<figure class="entry-cover">
    {{- $loading := cond $.IsSingle "eager" "lazy" }}
    {{- $addLink := (and site.Params.cover.linkFullImages $.IsSingle) }}
    {{- /* Only process images in actual production builds, not in server mode */}}
    {{- $prod := hugo.IsProduction }}
    {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) }}
    {{- $responsiveImages := (.Params.cover.responsiveImages | default site.Params.cover.responsiveImages) | default true }}

    {{- $pageBundleCover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
    {{- $globalResourcesCover := (resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
    
    {{- /* Try to get images from assets directory (for processing) */}}
    {{- $assetsCover := "" }}
    {{- if (and (not $pageBundleCover) (not $globalResourcesCover)) }}
        {{- $imagePath := .Params.cover.image }}
        {{- /* Extract filename from path like /images/filename.jpg */}}
        {{- $imageFilename := strings.TrimPrefix "/images/" $imagePath }}
        {{- if $imageFilename }}
            {{- $assetsCover = resources.Get (printf "images/%s" $imageFilename) }}
        {{- end }}
    {{- end }}
    
    {{- $cover := (or $pageBundleCover $globalResourcesCover $assetsCover) }}
    {{- /* We are not using the .Param.cover.relative to decide the location of image */}}
    {{- /* If we have the image in pageBundle, globalResources, or static folder we can process the image */}}

    {{- $sizes := (slice "360" "480" "720" "1080" "1500") }}
    {{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif") -}}
    {{- if hugo.IsExtended -}}
        {{- $processableFormats = $processableFormats | append "webp" -}}
    {{- end -}}

    {{- /* Always use original static path as fallback */}}
    {{- $imgdl := (.Params.cover.image) | absURL }}
    {{- /* Only use processed path in production builds */}}
    {{- if and $cover $prod -}}
        {{- $imgdl = $cover.Permalink }}
    {{- end -}}

    {{- if $addLink }}
        <a href="{{ $imgdl }}" target="_blank" rel="noopener noreferrer">
    {{- end }}

    {{- if $cover -}}
        {{/* Image is present in page bundle, global resources, or assets folder */}}
        {{- if (and (in $processableFormats $cover.MediaType.SubType) $responsiveImages $prod) }}
            {{- /* Only process in production builds where image processing works */}}
            {{- /* Calculate max display width - list pages show at 900px, single at 1000px */}}
            {{- $maxDisplayWidth := cond $.IsSingle 1000 900 }}
            {{- /* Use the smaller of image width or max display width for src */}}
            {{- $srcWidth := cond (gt $cover.Width $maxDisplayWidth) $maxDisplayWidth $cover.Width }}
            {{- $srcImage := cond (gt $cover.Width $maxDisplayWidth) ($cover.Resize (printf "%dx" $maxDisplayWidth)) $cover }}
            
            {{- /* Build srcset safely - only include valid sizes */}}
            {{- $srcsetParts := slice }}
            {{- range $size := $sizes -}}
                {{- $sizeInt := int $size }}
                {{- if and (ge $cover.Width $sizeInt) (le $sizeInt $maxDisplayWidth) }}
                    {{- $resized := $cover.Resize (printf "%dx" $sizeInt) }}
                    {{- if and $resized $resized.Permalink }}
                        {{- $srcsetParts = $srcsetParts | append (printf "%s %sw" $resized.Permalink $sizeInt) }}
                    {{- end }}
                {{- end }}
            {{- end }}
            {{- if and $srcImage $srcImage.Permalink }}
                {{- $srcsetParts = $srcsetParts | append (printf "%s %dw" $srcImage.Permalink $srcWidth) }}
            {{- end }}
            
            {{- if and (gt (len $srcsetParts) 0) $srcImage $srcImage.Permalink }}
            <img loading="{{$loading}}"
                srcset="{{ delimit $srcsetParts ", " }}"
                src="{{ $srcImage.Permalink }}"
                sizes="(min-width: 769px) {{ $maxDisplayWidth }}px, 100vw"
                width="{{ $srcWidth }}" 
                height="{{ $srcImage.Height }}"
                alt="{{ $alt }}">
            {{- else }}
                {{- /* Fallback if srcset generation failed - use original static path */}}
                <img loading="{{ $loading }}" src="{{ $imgdl }}" alt="{{ $alt }}">
            {{- end }}
        {{- else }}{{/* Unprocessable image, responsive images disabled, or not in production build */}}
            <img loading="{{ $loading }}" src="{{ $imgdl }}" alt="{{ $alt }}">
        {{- end }}
    {{- else }}
        {{- /* For absolute urls and external links, no img processing here */}}
        <img loading="{{ $loading }}" src="{{ $imgdl }}" alt="{{ $alt }}">
    {{- end }}

    {{- if $addLink }}
        </a>
    {{- end -}}

    {{- /*  Display Caption  */}}
    {{- if $.IsSingle }}
        {{ with .Params.cover.caption -}}
            <figcaption>{{ . | markdownify }}</figcaption>
        {{- end }}
    {{- end }}
</figure>
{{- end }}{{/* End image */}}
{{- end -}}{{/* End context */ -}}
